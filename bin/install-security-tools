#!/usr/bin/env python3
"""
Script d'installation des outils de sÃ©curitÃ© pour Athalia.
"""

from pathlib import Path
import subprocess
import sys


# Outils de sÃ©curitÃ© et qualitÃ©
SECURITY_TOOLS = [
    "black>=23.0.0",
    "flake8>=6.0.0",
    "mypy>=1.0.0",
    "isort>=5.12.0",
    "bandit>=1.7.0",
    "flake8-bugbear>=23.0.0",
    "flake8-builtins>=2.0.0",
    "flake8-quotes>=3.3.0",
    "pep8-naming>=0.13.0",
    "mccabe>=0.7.0",
    "pyupgrade>=3.0.0",
    "pre-commit>=3.0.0",
    "safety>=2.0.0",
    "pip-audit>=2.0.0",
    "types-requests",
    "types-PyYAML",
]


def install_tool(package: str) -> bool:
    """Installe un outil."""
    print(f"ğŸ“¦ Installation de {package}...")
    try:
        subprocess.run(
            [sys.executable, "-m", "pip", "install", package],
            check=True,
            capture_output=True,
            text=True,
        )
        print(f"âœ… {package} installÃ© avec succÃ¨s")
        return True
    except subprocess.CalledProcessError as e:
        print(f"âŒ Erreur lors de l'installation de {package}: {e}")
        return False


def setup_pre_commit() -> bool:
    """Configure pre-commit."""
    print("ğŸ”§ Configuration de pre-commit...")
    try:
        subprocess.run(["pre-commit", "install"], check=True)
        subprocess.run(
            ["pre-commit", "install", "--hook-type", "commit-msg"], check=True
        )
        print("âœ… Pre-commit configurÃ© avec succÃ¨s")
        return True
    except subprocess.CalledProcessError as e:
        print(f"âŒ Erreur lors de la configuration de pre-commit: {e}")
        return False


def main():
    """Fonction principale."""
    print("ğŸ›¡ï¸  INSTALLATION DES OUTILS DE SÃ‰CURITÃ‰")
    print("=" * 50)

    # VÃ©rifier que nous sommes dans le bon rÃ©pertoire
    if not Path("athalia_core").exists():
        print("âŒ Erreur: RÃ©pertoire athalia_core non trouvÃ©")
        print("   ExÃ©cutez ce script depuis la racine du projet")
        sys.exit(1)

    # Installer les outils
    success_count = 0
    total_count = len(SECURITY_TOOLS)

    for tool in SECURITY_TOOLS:
        if install_tool(tool):
            success_count += 1

    print(f"\nğŸ“Š RÃ©sumÃ©: {success_count}/{total_count} outils installÃ©s")

    if success_count == total_count:
        print("ğŸ‰ Tous les outils installÃ©s avec succÃ¨s!")

        # Configurer pre-commit
        if setup_pre_commit():
            print("\nğŸš€ Configuration terminÃ©e!")
            print("\nğŸ“‹ Prochaines Ã©tapes:")
            print("1. ExÃ©cutez: ./bin/ath-lint-secure")
            print("2. Ou utilisez: pre-commit run --all-files")
            print("3. Pour corriger automatiquement: black . && isort .")
        else:
            print("âš ï¸  Pre-commit non configurÃ©")
    else:
        print("âš ï¸  Certains outils n'ont pas pu Ãªtre installÃ©s")
        sys.exit(1)


if __name__ == "__main__":
    main()
