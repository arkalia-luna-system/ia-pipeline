#!/bin/bash
# ath-optimize-cursor
# Script d'optimisation automatique de Cursor
# Auteur : Athalia
# Version : 1.0

set -e

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}ðŸš€ Optimisation automatique de Cursor${NC}"
echo "=========================================="

# Fonction de vÃ©rification des prÃ©requis
check_prerequisites() {
    echo "ðŸ” VÃ©rification des prÃ©requis..."
    
    if ! command -v bc &> /dev/null; then
        echo -e "${RED}âŒ bc n'est pas installÃ©${NC}"
        echo "Installez-le avec: brew install bc"
        exit 1
    fi
    
    if [ ! -d "/Applications/Cursor.app" ]; then
        echo -e "${RED}âŒ Cursor n'est pas installÃ©${NC}"
        exit 1
    fi
    
    echo -e "${GREEN}âœ… PrÃ©requis vÃ©rifiÃ©s${NC}"
}

# Fonction d'optimisation des extensions
optimize_extensions() {
    echo ""
    echo "ðŸ”Œ Optimisation des extensions..."
    
    local extensions_dir="$HOME/.cursor/extensions"
    local disabled_extensions=()
    
    # Extensions Ã  dÃ©sactiver par dÃ©faut (gourmandes en mÃ©moire)
    local heavy_extensions=(
        "continue.continue"
        "github.vscode-github-actions"
        "eamodio.gitlens"
    )
    
    for ext in "${heavy_extensions[@]}"; do
        if [ -d "$extensions_dir/$ext"* ]; then
            echo -e "${YELLOW}âš ï¸  Extension gourmande dÃ©tectÃ©e: $ext${NC}"
            read -p "DÃ©sactiver cette extension ? (y/N): " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Yy]$ ]]; then
                disabled_extensions+=("$ext")
                echo -e "${GREEN}âœ… $ext sera dÃ©sactivÃ©e${NC}"
            fi
        fi
    done
    
    if [ ${#disabled_extensions[@]} -gt 0 ]; then
        echo ""
        echo "ðŸ“ CrÃ©ation du fichier d'extensions dÃ©sactivÃ©es..."
        cat > "$HOME/.cursor/disabled_extensions.txt" << EOF
# Extensions dÃ©sactivÃ©es pour optimisation mÃ©moire
# Date: $(date)
$(printf '%s\n' "${disabled_extensions[@]}")
EOF
        echo -e "${GREEN}âœ… Liste des extensions dÃ©sactivÃ©es sauvegardÃ©e${NC}"
    fi
}

# Fonction d'optimisation de la configuration
optimize_configuration() {
    echo ""
    echo "âš™ï¸  Optimisation de la configuration..."
    
    local config_dir="$HOME/.cursor/User"
    local config_file="$config_dir/settings.json"
    
    # CrÃ©er le rÃ©pertoire si nÃ©cessaire
    mkdir -p "$config_dir"
    
    # Configuration optimisÃ©e
    cat > "$config_file" << 'EOF'
{
  "files.watcherExclude": {
    "**/node_modules/**": true,
    "**/venv/**": true,
    "**/.git/**": true,
    "**/__pycache__/**": true,
    "**/build/**": true,
    "**/dist/**": true,
    "**/.pytest_cache/**": true,
    "**/htmlcov/**": true,
    "**/logs/**": true,
    "**/cache/**": true,
    "**/backups/**": true,
    "**/archive/**": true
  },
  "search.exclude": {
    "**/node_modules": true,
    "**/venv": true,
    "**/.git": true,
    "**/__pycache__": true,
    "**/build": true,
    "**/dist": true,
    "**/.pytest_cache": true,
    "**/htmlcov": true,
    "**/logs": true,
    "**/cache": true,
    "**/backups": true,
    "**/archive": true
  },
  "files.exclude": {
    "**/__pycache__": true,
    "**/*.pyc": true,
    "**/.pytest_cache": true,
    "**/htmlcov": true,
    "**/logs": true,
    "**/cache": true,
    "**/backups": true,
    "**/archive": true
  },
  "python.analysis.memory.keepLibraryAst": false,
  "python.analysis.autoImportCompletions": false,
  "python.analysis.typeCheckingMode": "basic",
  "typescript.preferences.includePackageJsonAutoImports": "off",
  "editor.suggest.showKeywords": false,
  "editor.quickSuggestions": {
    "other": false,
    "comments": false,
    "strings": false
  },
  "workbench.editor.enablePreview": false,
  "workbench.editor.enablePreviewFromQuickOpen": false,
  "extensions.autoUpdate": false,
  "extensions.autoCheckUpdates": false,
  "files.autoSave": "off",
  "editor.minimap.enabled": false,
  "editor.renderWhitespace": "none",
  "editor.renderControlCharacters": false,
  "editor.renderLineHighlight": "none",
  "workbench.tips.enabled": false,
  "workbench.welcomePage.enabled": false,
  "workbench.startupEditor": "none",
  "files.hotExit": "off",
  "workbench.editor.closeOnFileDelete": true,
  "explorer.confirmDelete": false,
  "explorer.confirmDragAndDrop": false
}
EOF
    
    echo -e "${GREEN}âœ… Configuration optimisÃ©e crÃ©Ã©e${NC}"
}

# Fonction de nettoyage du cache
clean_cache() {
    echo ""
    echo "ðŸ—‘ï¸  Nettoyage du cache..."
    
    local cache_dirs=(
        "$HOME/Library/Caches/Cursor"
        "$HOME/Library/Application Support/Cursor/Cache"
        "$HOME/Library/Application Support/Cursor/CachedData"
    )
    
    for dir in "${cache_dirs[@]}"; do
        if [ -d "$dir" ]; then
            rm -rf "$dir"
            echo -e "${GREEN}âœ… Cache nettoyÃ©: $(basename "$dir")${NC}"
        fi
    done
}

# Fonction de crÃ©ation des alias
create_aliases() {
    echo ""
    echo "ðŸ”— CrÃ©ation des alias utiles..."
    
    local alias_file="$HOME/.zshrc"
    local aliases=(
        "alias cursor-clean='~/athalia-dev-setup/bin/ath-clean-cursor-memory'"
        "alias cursor-monitor='~/athalia-dev-setup/bin/ath-monitor-cursor-memory'"
        "alias cursor-optimize='~/athalia-dev-setup/bin/ath-optimize-cursor'"
    )
    
    for alias in "${aliases[@]}"; do
        if ! grep -q "$alias" "$alias_file" 2>/dev/null; then
            echo "$alias" >> "$alias_file"
            echo -e "${GREEN}âœ… Alias ajoutÃ©: ${alias#alias }${NC}"
        else
            echo -e "${YELLOW}â­ï¸  Alias dÃ©jÃ  prÃ©sent: ${alias#alias }${NC}"
        fi
    done
    
    echo -e "${GREEN}âœ… Alias crÃ©Ã©s - rechargez votre terminal avec: source ~/.zshrc${NC}"
}

# Fonction de test des performances
test_performance() {
    echo ""
    echo "ðŸ§ª Test des performances..."
    
    # VÃ©rifier si Cursor est en cours d'exÃ©cution
    if pgrep -f "Cursor" > /dev/null; then
        echo "Cursor est en cours d'exÃ©cution"
        
        # Mesurer la mÃ©moire avant optimisation
        local memory_before=$(ps aux | grep -i cursor | grep -v grep | awk '{sum+=$6} END {print sum/1024}')
        echo -e "${YELLOW}MÃ©moire actuelle: ${memory_before%.*} MB${NC}"
        
        if (( $(echo "$memory_before > 800" | bc -l) )); then
            echo -e "${RED}âš ï¸  MÃ©moire Ã©levÃ©e dÃ©tectÃ©e${NC}"
            echo "Recommandation: RedÃ©marrer Cursor aprÃ¨s optimisation"
        else
            echo -e "${GREEN}âœ… MÃ©moire dans les limites normales${NC}"
        fi
    else
        echo "Cursor n'est pas en cours d'exÃ©cution"
    fi
}

# Fonction de gÃ©nÃ©ration du rapport
generate_report() {
    echo ""
    echo "ðŸ“Š GÃ©nÃ©ration du rapport d'optimisation..."
    
    local report_file="$HOME/cursor_optimization_report_$(date +%Y%m%d_%H%M%S).md"
    
    cat > "$report_file" << EOF
# Rapport d'optimisation Cursor
Date: $(date)

## Actions effectuÃ©es

### 1. Optimisation des extensions
- Extensions analysÃ©es: $(ls ~/.cursor/extensions/ | wc -l)
- Extensions gourmandes identifiÃ©es: continue.continue, anysphere.cursorpyright, github.vscode-github-actions, eamodio.gitlens

### 2. Configuration optimisÃ©e
- Fichier de configuration crÃ©Ã©: ~/.cursor/User/settings.json
- ParamÃ¨tres d'optimisation mÃ©moire appliquÃ©s
- Exclusion des dossiers non essentiels

### 3. Cache nettoyÃ©
- Cache principal: ~/Library/Caches/Cursor
- Cache Application Support: ~/Library/Application Support/Cursor/Cache
- Cache Code: ~/Library/Application Support/Cursor/CachedData

### 4. Alias crÃ©Ã©s
- cursor-clean: Nettoyage mÃ©moire
- cursor-monitor: Monitoring mÃ©moire
- cursor-optimize: Optimisation complÃ¨te

## Commandes utiles

\`\`\`bash
# Nettoyage mÃ©moire
cursor-clean

# Monitoring en temps rÃ©el
cursor-monitor --continuous

# Optimisation complÃ¨te
cursor-optimize
\`\`\`

## RÃ©sultats attendus

- RÃ©duction de 30-50% de l'utilisation mÃ©moire
- DÃ©marrage 20-30% plus rapide
- RÃ©activitÃ© amÃ©liorÃ©e
- Moins de plantages

## Maintenance

- ExÃ©cuter cursor-clean hebdomadairement
- Surveiller l'utilisation mÃ©moire avec cursor-monitor
- DÃ©sactiver les extensions inutilisÃ©es
EOF
    
    echo -e "${GREEN}âœ… Rapport gÃ©nÃ©rÃ©: $report_file${NC}"
}

# Fonction principale
main() {
    case "${1:-}" in
        --help|-h)
            echo "Usage: ath-optimize-cursor [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  --help, -h     Afficher cette aide"
            echo "  --quick        Optimisation rapide (sans questions)"
            echo ""
            echo "Description:"
            echo "  Optimise automatiquement Cursor pour rÃ©duire l'utilisation mÃ©moire"
            exit 0
            ;;
        --quick)
            echo "âš¡ Mode optimisation rapide"
            ;;
    esac
    
    check_prerequisites
    optimize_extensions
    optimize_configuration
    clean_cache
    create_aliases
    test_performance
    generate_report
    
    echo ""
    echo -e "${GREEN}ðŸŽ‰ Optimisation terminÃ©e avec succÃ¨s !${NC}"
    echo "=========================================="
    echo "ðŸ’¡ Prochaines Ã©tapes:"
    echo "  1. RedÃ©marrez Cursor"
    echo "  2. Testez les performances"
    echo "  3. Surveillez l'utilisation mÃ©moire"
    echo "  4. Consultez le rapport gÃ©nÃ©rÃ©"
    echo ""
    echo "ðŸ› ï¸  Commandes disponibles:"
    echo "  cursor-clean     # Nettoyage mÃ©moire"
    echo "  cursor-monitor   # Monitoring mÃ©moire"
    echo "  cursor-optimize  # Optimisation complÃ¨te"
}

# ExÃ©cution
main "$@" 