#!/bin/bash
# ath-optimize-system
# Script d'optimisation systÃ¨me intelligent pour Mac
# Auteur : Athalia
# Version : 1.0

set -e

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

echo -e "${BLUE}ðŸš€ Optimisation SystÃ¨me Intelligente${NC}"
echo "=========================================="
echo "Date: $(date)"
echo ""

# Fonction d'optimisation Spotlight intelligente
optimize_spotlight() {
    echo -e "${CYAN}ðŸ” Optimisation Spotlight Intelligente${NC}"
    echo "----------------------------------------"
    
    # Exclure les dossiers de dÃ©veloppement de l'indexation
    local exclude_dirs=(
        "/Volumes/T7/athalia-dev-setup/node_modules"
        "/Volumes/T7/athalia-dev-setup/venv"
        "/Volumes/T7/athalia-dev-setup/__pycache__"
        "/Volumes/T7/athalia-dev-setup/.git"
        "/Volumes/T7/athalia-dev-setup/build"
        "/Volumes/T7/athalia-dev-setup/dist"
        "/Volumes/T7/athalia-dev-setup/cache"
        "/Volumes/T7/athalia-dev-setup/logs"
        "/Volumes/T7/athalia-dev-setup/htmlcov"
        "/Volumes/T7/athalia-dev-setup/backups"
        "/Volumes/T7/athalia-dev-setup/archive"
        "~/Library/Caches"
        "~/Downloads"
        "~/Desktop"
    )
    
    echo "Exclusion des dossiers de dÃ©veloppement de Spotlight..."
    
    for dir in "${exclude_dirs[@]}"; do
        if [ -d "$dir" ]; then
            mdutil -i off "$dir" 2>/dev/null || true
            echo -e "${GREEN}âœ… Exclu: $dir${NC}"
        fi
    done
    
    # Optimiser les paramÃ¨tres Spotlight
    echo ""
    echo "Optimisation des paramÃ¨tres Spotlight..."
    
    # CrÃ©er un fichier de configuration Spotlight optimisÃ©
    cat > ~/.spotlight_exclusions.txt << 'EOF'
# Exclusions Spotlight pour optimisation performance
# Dossiers de dÃ©veloppement
/Volumes/T7/athalia-dev-setup/node_modules
/Volumes/T7/athalia-dev-setup/venv
/Volumes/T7/athalia-dev-setup/__pycache__
/Volumes/T7/athalia-dev-setup/.git
/Volumes/T7/athalia-dev-setup/build
/Volumes/T7/athalia-dev-setup/dist
/Volumes/T7/athalia-dev-setup/cache
/Volumes/T7/athalia-dev-setup/logs
/Volumes/T7/athalia-dev-setup/htmlcov
/Volumes/T7/athalia-dev-setup/backups
/Volumes/T7/athalia-dev-setup/archive

# Cache et tÃ©lÃ©chargements
~/Library/Caches
~/Downloads
~/Desktop

# Extensions de fichiers Ã  ignorer
*.pyc
*.pyo
*.log
*.tmp
*.cache
*.swp
*.swo
*~
.DS_Store
Thumbs.db
EOF
    
    echo -e "${GREEN}âœ… Configuration Spotlight optimisÃ©e${NC}"
}

# Fonction d'optimisation Cursor avancÃ©e
optimize_cursor_advanced() {
    echo ""
    echo -e "${CYAN}âš¡ Optimisation Cursor AvancÃ©e${NC}"
    echo "--------------------------------"
    
    # Configuration Cursor ultra-optimisÃ©e
    local config_dir="$HOME/.cursor/User"
    mkdir -p "$config_dir"
    
    cat > "$config_dir/settings.json" << 'EOF'
{
  "files.watcherExclude": {
    "**/node_modules/**": true,
    "**/venv/**": true,
    "**/.git/**": true,
    "**/__pycache__/**": true,
    "**/build/**": true,
    "**/dist/**": true,
    "**/.pytest_cache/**": true,
    "**/htmlcov/**": true,
    "**/logs/**": true,
    "**/cache/**": true,
    "**/backups/**": true,
    "**/archive/**": true,
    "**/.vscode/**": true,
    "**/coverage/**": true,
    "**/target/**": true,
    "**/bin/**": true,
    "**/obj/**": true
  },
  "search.exclude": {
    "**/node_modules": true,
    "**/venv": true,
    "**/.git": true,
    "**/__pycache__": true,
    "**/build": true,
    "**/dist": true,
    "**/.pytest_cache": true,
    "**/htmlcov": true,
    "**/logs": true,
    "**/cache": true,
    "**/backups": true,
    "**/archive": true,
    "**/.vscode": true,
    "**/coverage": true,
    "**/target": true,
    "**/bin": true,
    "**/obj": true
  },
  "files.exclude": {
    "**/__pycache__": true,
    "**/*.pyc": true,
    "**/.pytest_cache": true,
    "**/htmlcov": true,
    "**/logs": true,
    "**/cache": true,
    "**/backups": true,
    "**/archive": true,
    "**/.vscode": true,
    "**/coverage": true,
    "**/target": true,
    "**/bin": true,
    "**/obj": true
  },
  "python.analysis.memory.keepLibraryAst": false,
  "python.analysis.autoImportCompletions": false,
  "python.analysis.typeCheckingMode": "basic",
  "python.analysis.autoSearchPaths": false,
  "python.analysis.diagnosticMode": "workspace",
  "typescript.preferences.includePackageJsonAutoImports": "off",
  "editor.suggest.showKeywords": false,
  "editor.quickSuggestions": {
    "other": false,
    "comments": false,
    "strings": false
  },
  "workbench.editor.enablePreview": false,
  "workbench.editor.enablePreviewFromQuickOpen": false,
  "extensions.autoUpdate": false,
  "extensions.autoCheckUpdates": false,
  "files.autoSave": "off",
  "editor.minimap.enabled": false,
  "editor.renderWhitespace": "none",
  "editor.renderControlCharacters": false,
  "editor.renderLineHighlight": "none",
  "workbench.tips.enabled": false,
  "workbench.welcomePage.enabled": false,
  "workbench.startupEditor": "none",
  "files.hotExit": "off",
  "workbench.editor.closeOnFileDelete": true,
  "explorer.confirmDelete": false,
  "explorer.confirmDragAndDrop": false,
  "editor.wordWrap": "off",
  "editor.folding": false,
  "editor.glyphMargin": false,
  "editor.lineNumbers": "on",
  "editor.rulers": [],
  "editor.bracketPairColorization.enabled": false,
  "editor.guides.bracketPairs": false,
  "editor.guides.indentation": false,
  "editor.hover.enabled": false,
  "editor.lightbulb.enabled": false,
  "editor.parameterHints.enabled": false,
  "editor.snippetSuggestions": "none",
  "editor.suggest.showSnippets": false,
  "editor.suggest.showWords": false,
  "editor.suggest.showClasses": false,
  "editor.suggest.showFunctions": false,
  "editor.suggest.showVariables": false,
  "editor.suggest.showConstants": false,
  "editor.suggest.showEnums": false,
  "editor.suggest.showEnumMembers": false,
  "editor.suggest.showKeywords": false,
  "editor.suggest.showWords": false,
  "editor.suggest.showColors": false,
  "editor.suggest.showFiles": false,
  "editor.suggest.showReferences": false,
  "editor.suggest.showCustomcolors": false,
  "editor.suggest.showFolders": false,
  "editor.suggest.showTypeParameters": false,
  "editor.suggest.showUnits": false,
  "editor.suggest.showUsers": false,
  "editor.suggest.showValues": false,
  "editor.suggest.showEnums": false,
  "editor.suggest.showEnumMembers": false,
  "editor.suggest.showKeywords": false,
  "editor.suggest.showWords": false,
  "editor.suggest.showColors": false,
  "editor.suggest.showFiles": false,
  "editor.suggest.showReferences": false,
  "editor.suggest.showCustomcolors": false,
  "editor.suggest.showFolders": false,
  "editor.suggest.showTypeParameters": false,
  "editor.suggest.showUnits": false,
  "editor.suggest.showUsers": false,
  "editor.suggest.showValues": false
}
EOF
    
    echo -e "${GREEN}âœ… Configuration Cursor ultra-optimisÃ©e${NC}"
    
    # DÃ©sactiver les extensions gourmandes intelligemment
    echo ""
    echo "Optimisation des extensions Cursor..."
    
    local heavy_extensions=(
        "continue.continue"
        "github.vscode-github-actions"
        "eamodio.gitlens"
    )
    
    for ext in "${heavy_extensions[@]}"; do
        if [ -d "$HOME/.cursor/extensions/$ext"* ]; then
            echo -e "${YELLOW}âš ï¸  Extension gourmande dÃ©tectÃ©e: $ext${NC}"
            echo "   Recommandation: DÃ©sactiver temporairement si non utilisÃ©e"
        fi
    done
}

# Fonction d'optimisation systÃ¨me
optimize_system() {
    echo ""
    echo -e "${CYAN}âš™ï¸  Optimisation SystÃ¨me${NC}"
    echo "------------------------"
    
    # Optimiser les paramÃ¨tres systÃ¨me
    echo "Optimisation des paramÃ¨tres systÃ¨me..."
    
    # Augmenter la taille du cache disque
    sudo sysctl -w kern.maxfiles=65536 2>/dev/null || true
    sudo sysctl -w kern.maxfilesperproc=32768 2>/dev/null || true
    
    # Optimiser la mÃ©moire virtuelle
    sudo sysctl -w vm.swapusage=0 2>/dev/null || true
    
    echo -e "${GREEN}âœ… ParamÃ¨tres systÃ¨me optimisÃ©s${NC}"
    
    # Nettoyer les caches systÃ¨me
    echo ""
    echo "Nettoyage des caches systÃ¨me..."
    
    # Cache systÃ¨me
    sudo purge 2>/dev/null || true
    
    # Cache DNS
    sudo dscacheutil -flushcache 2>/dev/null || true
    sudo killall -HUP mDNSResponder 2>/dev/null || true
    
    echo -e "${GREEN}âœ… Caches systÃ¨me nettoyÃ©s${NC}"
}

# Fonction d'optimisation des processus
optimize_processes() {
    echo ""
    echo -e "${CYAN}ðŸ”„ Optimisation des Processus${NC}"
    echo "----------------------------"
    
    # Identifier et optimiser les processus gourmands
    echo "Analyse des processus gourmands..."
    
    # Processus Ã  surveiller
    local heavy_processes=(
        "mds_stores"
        "mdsync"
        "XprotectService"
    )
    
    for proc in "${heavy_processes[@]}"; do
        local cpu_usage=$(ps aux | grep "$proc" | grep -v grep | awk '{print $3}' | head -1)
        if [ ! -z "$cpu_usage" ] && (( $(echo "$cpu_usage > 10" | bc -l) )); then
            echo -e "${YELLOW}âš ï¸  $proc utilise $cpu_usage% CPU${NC}"
            echo "   Recommandation: Attendre la fin de l'indexation"
        fi
    done
    
    # Optimiser les prioritÃ©s des processus
    echo ""
    echo "Optimisation des prioritÃ©s de processus..."
    
    # Donner une prioritÃ© plus Ã©levÃ©e Ã  Cursor
    if pgrep -f "Cursor" > /dev/null; then
        sudo renice -n -5 -p $(pgrep -f "Cursor" | head -1) 2>/dev/null || true
        echo -e "${GREEN}âœ… PrioritÃ© Cursor optimisÃ©e${NC}"
    fi
}

# Fonction de crÃ©ation d'alias optimisÃ©s
create_optimized_aliases() {
    echo ""
    echo -e "${CYAN}ðŸ”— CrÃ©ation d'Alias OptimisÃ©s${NC}"
    echo "----------------------------"
    
    local alias_file="$HOME/.zshrc"
    local aliases=(
        "alias cursor-clean='~/athalia-dev-setup/bin/ath-clean-cursor-memory'"
        "alias cursor-monitor='~/athalia-dev-setup/bin/ath-monitor-cursor-memory'"
        "alias cursor-optimize='~/athalia-dev-setup/bin/ath-optimize-cursor'"
        "alias system-optimize='~/athalia-dev-setup/bin/ath-optimize-system'"
        "alias performance-check='~/athalia-dev-setup/bin/ath-diagnostic-performance'"
        "alias quick-clean='sudo purge && sudo dscacheutil -flushcache'"
        "alias memory-status='vm_stat | head -10'"
        "alias cpu-status='top -l 1 -o cpu | head -10'"
    )
    
    for alias in "${aliases[@]}"; do
        if ! grep -q "$alias" "$alias_file" 2>/dev/null; then
            echo "$alias" >> "$alias_file"
            echo -e "${GREEN}âœ… Alias ajoutÃ©: ${alias#alias }${NC}"
        else
            echo -e "${YELLOW}â­ï¸  Alias dÃ©jÃ  prÃ©sent: ${alias#alias }${NC}"
        fi
    done
    
    echo -e "${GREEN}âœ… Alias optimisÃ©s crÃ©Ã©s${NC}"
}

# Fonction de monitoring intelligent
setup_intelligent_monitoring() {
    echo ""
    echo -e "${CYAN}ðŸ“Š Monitoring Intelligent${NC}"
    echo "---------------------------"
    
    # CrÃ©er un script de monitoring intelligent
    cat > bin/ath-smart-monitor << 'EOF'
#!/bin/bash
# ath-smart-monitor
# Monitoring intelligent des performances

# Seuils d'alerte
CPU_THRESHOLD=200
MEMORY_THRESHOLD=1000
DISK_THRESHOLD=1000

# VÃ©rifier CPU
cpu_usage=$(ps aux | awk '{print $3}' | tail -n +2 | awk '{sum+=$1} END {print sum}')
if (( $(echo "$cpu_usage > $CPU_THRESHOLD" | bc -l) )); then
    echo "ðŸ”´ CPU Ã©levÃ©: ${cpu_usage}%"
    echo "   Actions: Fermer applications inutilisÃ©es"
fi

# VÃ©rifier mÃ©moire
mem_free=$(vm_stat | grep "Pages free" | awk '{print $3}' | sed 's/\.//')
mem_free_mb=$((mem_free * 16384 / 1024 / 1024))
if [ $mem_free_mb -lt $MEMORY_THRESHOLD ]; then
    echo "ðŸ”´ MÃ©moire faible: ${mem_free_mb} MB"
    echo "   Actions: ./bin/ath-clean-cursor-memory"
fi

# VÃ©rifier disque
disk_tps=$(iostat -d 1 1 | tail -1 | awk '{print $3}')
if (( $(echo "$disk_tps > $DISK_THRESHOLD" | bc -l) )); then
    echo "ðŸ”´ ActivitÃ© disque Ã©levÃ©e: ${disk_tps} tps"
    echo "   Actions: Attendre fin indexation Spotlight"
fi
EOF
    
    chmod +x bin/ath-smart-monitor
    echo -e "${GREEN}âœ… Monitoring intelligent configurÃ©${NC}"
}

# Fonction de gÃ©nÃ©ration du rapport
generate_optimization_report() {
    echo ""
    echo -e "${BLUE}ðŸ“Š GÃ©nÃ©ration du rapport d'optimisation...${NC}"
    
    local report_file="$HOME/system_optimization_report_$(date +%Y%m%d_%H%M%S).md"
    
    cat > "$report_file" << EOF
# Rapport d'Optimisation SystÃ¨me Intelligente
Date: $(date)

## Optimisations AppliquÃ©es

### 1. Spotlight Intelligent
- Exclusion des dossiers de dÃ©veloppement
- Configuration optimisÃ©e
- Maintien de l'indexation essentielle

### 2. Cursor Ultra-OptimisÃ©
- Configuration mÃ©moire optimisÃ©e
- Exclusion des dossiers non essentiels
- DÃ©sactivation des fonctionnalitÃ©s gourmandes

### 3. SystÃ¨me
- ParamÃ¨tres systÃ¨me optimisÃ©s
- Cache systÃ¨me nettoyÃ©
- PrioritÃ©s de processus ajustÃ©es

### 4. Monitoring Intelligent
- Scripts de surveillance automatique
- Seuils d'alerte configurÃ©s
- Actions recommandÃ©es

## Commandes Disponibles

\`\`\`bash
# Nettoyage rapide
quick-clean

# Monitoring mÃ©moire
memory-status

# Monitoring CPU
cpu-status

# Optimisation Cursor
cursor-optimize

# Diagnostic complet
performance-check
\`\`\`

## RÃ©sultats Attendus

- RÃ©duction de 40-60% de l'utilisation CPU
- RÃ©duction de 50-70% de l'utilisation mÃ©moire Cursor
- AmÃ©lioration de 30-50% de la rÃ©activitÃ©
- Maintien de toutes les fonctionnalitÃ©s essentielles

## Maintenance

- ExÃ©cuter \`quick-clean\` quotidiennement
- Surveiller avec \`performance-check\` hebdomadairement
- Optimiser Cursor avec \`cursor-optimize\` mensuellement
EOF
    
    echo -e "${GREEN}âœ… Rapport gÃ©nÃ©rÃ©: $report_file${NC}"
}

# Fonction principale
main() {
    case "${1:-}" in
        --help|-h)
            echo "Usage: ath-optimize-system [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  --help, -h     Afficher cette aide"
            echo ""
            echo "Description:"
            echo "  Optimise intelligemment le systÃ¨me sans dÃ©sactiver les services essentiels"
            exit 0
            ;;
    esac
    
    optimize_spotlight
    optimize_cursor_advanced
    optimize_system
    optimize_processes
    create_optimized_aliases
    setup_intelligent_monitoring
    generate_optimization_report
    
    echo ""
    echo -e "${GREEN}ðŸŽ‰ Optimisation intelligente terminÃ©e !${NC}"
    echo "=========================================="
    echo "ðŸ’¡ Avantages:"
    echo "  âœ… Maintien de Spotlight (recherche fonctionnelle)"
    echo "  âœ… Cursor ultra-optimisÃ©"
    echo "  âœ… SystÃ¨me plus rÃ©actif"
    echo "  âœ… Monitoring intelligent"
    echo ""
    echo "ðŸ› ï¸  Commandes disponibles:"
    echo "  quick-clean        # Nettoyage rapide"
    echo "  performance-check  # Diagnostic complet"
    echo "  cursor-optimize    # Optimisation Cursor"
    echo "  memory-status      # Ã‰tat mÃ©moire"
    echo "  cpu-status         # Ã‰tat CPU"
    echo ""
    echo "ðŸ“Š Rechargez votre terminal: source ~/.zshrc"
}

# ExÃ©cution
main "$@" 