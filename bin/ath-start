#!/bin/bash
# ğŸš€ Script de dÃ©marrage optimisÃ© pour Athalia/Arkalia
# VÃ©rifie et nettoie l'environnement avant de dÃ©marrer

echo "ğŸš€ DÃ©marrage optimisÃ© d'Athalia/Arkalia..."

# Variables
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Fonction pour vÃ©rifier les processus existants
check_existing_processes() {
    echo "ğŸ” VÃ©rification des processus existants..."
    
    ATHALIA_PROCESSES=$(ps aux | grep -c "[a]thalia_core.main" || echo "0")
    if [ "$ATHALIA_PROCESSES" -gt 0 ]; then
        echo "   âš ï¸  $ATHALIA_PROCESSES processus Athalia dÃ©jÃ  en cours"
        read -p "   Voulez-vous les arrÃªter et redÃ©marrer ? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            echo "   ğŸ”ª ArrÃªt des processus existants..."
            pkill -f "athalia_core.main" 2>/dev/null
            sleep 2
            echo "   âœ… Processus arrÃªtÃ©s"
        else
            echo "   â„¹ï¸  Utilisation des processus existants"
            return 1
        fi
    else
        echo "   âœ… Aucun processus Athalia en cours"
    fi
    return 0
}

# Fonction pour vÃ©rifier l'environnement
check_environment() {
    echo "ğŸ”§ VÃ©rification de l'environnement..."
    
    # VÃ©rifier Python
    if ! command -v python3 &> /dev/null; then
        echo "   âŒ Python3 non trouvÃ©"
        return 1
    fi
    echo "   âœ… Python3 disponible"
    
    # VÃ©rifier les dÃ©pendances
    if [ ! -f "requirements.txt" ] && [ ! -f "config/requirements.txt" ]; then
        echo "   âš ï¸  Fichier requirements.txt non trouvÃ©"
    else
        echo "   âœ… DÃ©pendances disponibles"
    fi
    
    # VÃ©rifier la configuration
    if [ ! -f "config/athalia_config.yaml" ]; then
        echo "   âŒ Configuration athalia_config.yaml non trouvÃ©e"
        return 1
    fi
    echo "   âœ… Configuration disponible"
    
    return 0
}

# Fonction pour nettoyer rapidement
quick_cleanup() {
    echo "ğŸ§¹ Nettoyage rapide..."
    
    # Supprimer les caches Python
    find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null
    find . -name "*.pyc" -type f -delete 2>/dev/null
    
    # Supprimer les fichiers temporaires
    find . -name "*.tmp" -o -name "*.temp" -o -name "*~" -delete 2>/dev/null
    
    echo "   âœ… Nettoyage terminÃ©"
}

# Fonction pour dÃ©marrer en mode optimisÃ©
start_optimized() {
    echo "ğŸš€ DÃ©marrage d'Athalia en mode optimisÃ©..."
    
    # Variables d'environnement pour optimiser
    export PYTHONOPTIMIZE=1
    export PYTHONDONTWRITEBYTECODE=1
    export PYTHONUNBUFFERED=1
    
    # DÃ©marrer avec gestion d'erreurs
    cd "$PROJECT_ROOT"
    
    echo "   ğŸ“ RÃ©pertoire de travail: $(pwd)"
    echo "   ğŸ Lancement: python3 -m athalia_core.main"
    echo ""
    echo "ğŸ’¡ Conseils:"
    echo "   - Utilisez Ctrl+C pour arrÃªter proprement"
    echo "   - Utilisez 'ark-process-check.sh' pour surveiller les processus"
    echo "   - Utilisez 'ath-clean' pour nettoyer rÃ©guliÃ¨rement"
    echo ""
    
    # DÃ©marrer Athalia
    python3 -m athalia_core.main
}

# Fonction pour dÃ©marrer en mode dÃ©veloppement
start_development() {
    echo "ğŸ”§ DÃ©marrage d'Athalia en mode dÃ©veloppement..."
    
    # Activer les logs dÃ©taillÃ©s
    export ATHALIA_DEBUG=1
    export ATHALIA_VERBOSE=1
    
    cd "$PROJECT_ROOT"
    
    echo "   ğŸ“ RÃ©pertoire de travail: $(pwd)"
    echo "   ğŸ Lancement: python3 -m athalia_core.main (mode debug)"
    echo ""
    
    python3 -m athalia_core.main
}

# Fonction pour dÃ©marrer en mode surveillance
start_monitoring() {
    echo "ğŸ‘ï¸  DÃ©marrage d'Athalia en mode surveillance..."
    
    cd "$PROJECT_ROOT"
    
    echo "   ğŸ“ RÃ©pertoire de travail: $(pwd)"
    echo "   ğŸ Lancement: python3 -m athalia_core.main"
    echo "   ğŸ” Mode surveillance activÃ©"
    echo ""
    
    # DÃ©marrer et passer directement au mode surveillance
    echo "14" | python3 -m athalia_core.main
}

# Menu principal
show_menu() {
    echo ""
    echo "ğŸ¯ Choisissez le mode de dÃ©marrage :"
    echo "1. Mode optimisÃ© (recommandÃ©)"
    echo "2. Mode dÃ©veloppement (logs dÃ©taillÃ©s)"
    echo "3. Mode surveillance continue"
    echo "4. Nettoyage complet puis dÃ©marrage"
    echo "5. Quitter"
    echo ""
}

# VÃ©rifications prÃ©liminaires
if ! check_environment; then
    echo "âŒ Environnement non valide. VÃ©rifiez l'installation."
    exit 1
fi

# VÃ©rifier les processus existants
if check_existing_processes; then
    # Continuer avec le dÃ©marrage
    :
else
    # Processus existants conservÃ©s
    exit 0
fi

# Menu de dÃ©marrage
while true; do
    show_menu
    read -p "Choix (1-5): " -n 1 -r
    echo
    
    case $REPLY in
        1)
            quick_cleanup
            start_optimized
            break
            ;;
        2)
            quick_cleanup
            start_development
            break
            ;;
        3)
            quick_cleanup
            start_monitoring
            break
            ;;
        4)
            echo "ğŸ§¹ Nettoyage complet en cours..."
            ./bin/ath-clean
            echo ""
            start_optimized
            break
            ;;
        5)
            echo "ğŸ‘‹ Au revoir !"
            exit 0
            ;;
        *)
            echo "âŒ Choix invalide"
            ;;
    esac
done 