#!/bin/bash
# ath-optimize-intelligent
# Optimisation intelligente SANS d√©sactiver les services essentiels
# Auteur : Athalia
# Version : 1.0

set -e

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

echo -e "${BLUE}üß† Optimisation Intelligente - SANS D√©sactivation${NC}"
echo "=================================================="
echo "Date: $(date)"
echo ""

# Fonction d'optimisation Spotlight intelligente
optimize_spotlight_intelligent() {
    echo -e "${CYAN}üîç Optimisation Spotlight Intelligente${NC}"
    echo "----------------------------------------"

    # Cr√©er un fichier d'exclusions sp√©cifique au projet
    local exclusions_file="$HOME/.spotlight_project_exclusions.txt"
    
    cat > "$exclusions_file" << 'EOF'
# Exclusions Spotlight sp√©cifiques au projet Athalia
# Optimisation intelligente - ne d√©sactive pas Spotlight

# Dossiers de d√©veloppement lourds
/Volumes/T7/athalia-dev-setup/node_modules
/Volumes/T7/athalia-dev-setup/venv
/Volumes/T7/athalia-dev-setup/.venv
/Volumes/T7/athalia-dev-setup/__pycache__
/Volumes/T7/athalia-dev-setup/.git
/Volumes/T7/athalia-dev-setup/build
/Volumes/T7/athalia-dev-setup/dist
/Volumes/T7/athalia-dev-setup/cache
/Volumes/T7/athalia-dev-setup/logs
/Volumes/T7/athalia-dev-setup/htmlcov
/Volumes/T7/athalia-dev-setup/backups
/Volumes/T7/athalia-dev-setup/archive
/Volumes/T7/athalia-dev-setup/.pytest_cache
/Volumes/T7/athalia-dev-setup/.mypy_cache
/Volumes/T7/athalia-dev-setup/coverage

# Fichiers temporaires et cache
*.pyc
*.pyo
*.log
*.tmp
*.cache
*.swp
*.swo
*~
.DS_Store
Thumbs.db

# Dossiers syst√®me lourds
~/Library/Caches
~/Downloads
~/Desktop
EOF

    # Appliquer les exclusions de mani√®re intelligente
    echo "   üìù Application des exclusions Spotlight..."
    
    # Exclure les dossiers du projet de mani√®re cibl√©e
    mdutil -i off /Volumes/T7/athalia-dev-setup/node_modules 2>/dev/null || true
    mdutil -i off /Volumes/T7/athalia-dev-setup/venv 2>/dev/null || true
    mdutil -i off /Volumes/T7/athalia-dev-setup/.venv 2>/dev/null || true
    mdutil -i off /Volumes/T7/athalia-dev-setup/__pycache__ 2>/dev/null || true
    mdutil -i off /Volumes/T7/athalia-dev-setup/cache 2>/dev/null || true
    mdutil -i off /Volumes/T7/athalia-dev-setup/logs 2>/dev/null || true
    mdutil -i off /Volumes/T7/athalia-dev-setup/htmlcov 2>/dev/null || true
    mdutil -i off /Volumes/T7/athalia-dev-setup/backups 2>/dev/null || true
    mdutil -i off /Volumes/T7/athalia-dev-setup/archive 2>/dev/null || true

    echo -e "${GREEN}   ‚úÖ Spotlight optimis√© intelligemment${NC}"
}

# Fonction d'optimisation des caches syst√®me
optimize_system_caches() {
    echo ""
    echo -e "${CYAN}üíæ Optimisation des Caches Syst√®me${NC}"
    echo "--------------------------------"

    echo "   üßπ Nettoyage des caches DNS..."
    sudo dscacheutil -flushcache 2>/dev/null || true
    sudo killall -HUP mDNSResponder 2>/dev/null || true

    echo "   üßπ Nettoyage des caches syst√®me..."
    sudo purge 2>/dev/null || true

    echo "   üßπ Nettoyage des caches de d√©veloppement..."
    find /Volumes/T7/athalia-dev-setup -name "*.pyc" -delete 2>/dev/null || true
    find /Volumes/T7/athalia-dev-setup -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
    find /Volumes/T7/athalia-dev-setup -name ".pytest_cache" -type d -exec rm -rf {} + 2>/dev/null || true
    find /Volumes/T7/athalia-dev-setup -name ".mypy_cache" -type d -exec rm -rf {} + 2>/dev/null || true

    echo -e "${GREEN}   ‚úÖ Caches syst√®me optimis√©s${NC}"
}

# Fonction d'optimisation des processus
optimize_processes_intelligent() {
    echo ""
    echo -e "${CYAN}‚öôÔ∏è  Optimisation des Processus${NC}"
    echo "----------------------------"

    # Optimiser la priorit√© de Cursor (plus √©lev√©e)
    echo "   üéØ Optimisation de la priorit√© Cursor..."
    pids=$(pgrep -f "Cursor")
    for pid in $pids; do
        renice -n -5 -p "$pid" 2>/dev/null || true
    done

    # Optimiser les processus Python de d√©veloppement
    echo "   üêç Optimisation des processus Python..."
    python_pids=$(pgrep -f "python.*athalia")
    for pid in $python_pids; do
        renice -n -3 -p "$pid" 2>/dev/null || true
    done

    echo -e "${GREEN}   ‚úÖ Processus optimis√©s${NC}"
}

# Fonction d'optimisation Cursor intelligente
optimize_cursor_intelligent() {
    echo ""
    echo -e "${CYAN}üéØ Optimisation Cursor Intelligente${NC}"
    echo "-----------------------------------"

    # Cr√©er un fichier de configuration optimis√©
    local cursor_settings="$HOME/.cursor/User/settings_optimized.json"
    
    cat > "$cursor_settings" << 'EOF'
{
  "files.watcherExclude": {
    "**/node_modules/**": true,
    "**/venv/**": true,
    "**/.git/**": true,
    "**/__pycache__/**": true,
    "**/build/**": true,
    "**/dist/**": true,
    "**/.pytest_cache/**": true,
    "**/htmlcov/**": true,
    "**/logs/**": true,
    "**/cache/**": true,
    "**/backups/**": true,
    "**/archive/**": true,
    "**/.vscode/**": true,
    "**/coverage/**": true,
    "**/target/**": true,
    "**/bin/**": true,
    "**/obj/**": true,
    "**/.mypy_cache/**": true,
    "**/.ruff_cache/**": true
  },
  "search.exclude": {
    "**/node_modules": true,
    "**/venv": true,
    "**/.git": true,
    "**/__pycache__": true,
    "**/build": true,
    "**/dist": true,
    "**/.pytest_cache": true,
    "**/htmlcov": true,
    "**/logs": true,
    "**/cache": true,
    "**/backups": true,
    "**/archive": true,
    "**/.vscode": true,
    "**/coverage": true,
    "**/target": true,
    "**/bin": true,
    "**/obj": true,
    "**/.mypy_cache": true,
    "**/.ruff_cache": true
  },
  "files.exclude": {
    "**/__pycache__": true,
    "**/*.pyc": true,
    "**/.pytest_cache": true,
    "**/htmlcov": true,
    "**/logs": true,
    "**/cache": true,
    "**/backups": true,
    "**/archive": true,
    "**/.vscode": true,
    "**/coverage": true,
    "**/target": true,
    "**/bin": true,
    "**/obj": true,
    "**/.mypy_cache": true,
    "**/.ruff_cache": true
  },
  "python.analysis.memory.keepLibraryAst": false,
  "python.analysis.autoImportCompletions": false,
  "python.analysis.typeCheckingMode": "basic",
  "python.analysis.autoSearchPaths": false,
  "python.analysis.diagnosticMode": "workspace",
  "typescript.preferences.includePackageJsonAutoImports": "off",
  "editor.suggest.showKeywords": false,
  "editor.quickSuggestions": {
    "other": false,
    "comments": false,
    "strings": false
  },
  "workbench.editor.enablePreview": false,
  "workbench.editor.enablePreviewFromQuickOpen": false,
  "extensions.autoUpdate": false,
  "extensions.autoCheckUpdates": false,
  "files.autoSave": "off",
  "editor.minimap.enabled": false,
  "editor.renderWhitespace": "none",
  "editor.renderControlCharacters": false,
  "editor.renderLineHighlight": "none",
  "workbench.tips.enabled": false,
  "workbench.welcomePage.enabled": false,
  "workbench.startupEditor": "none",
  "files.hotExit": "off",
  "workbench.editor.closeOnFileDelete": true,
  "explorer.confirmDelete": false,
  "explorer.confirmDragAndDrop": false,
  "editor.wordWrap": "off",
  "editor.folding": false,
  "editor.glyphMargin": false,
  "editor.lineNumbers": "on",
  "editor.rulers": [],
  "editor.bracketPairColorization.enabled": false,
  "editor.guides.bracketPairs": false,
  "editor.guides.indentation": false,
  "editor.hover.enabled": false,
  "editor.lightbulb.enabled": false,
  "editor.parameterHints.enabled": false,
  "editor.snippetSuggestions": "none",
  "editor.suggest.showSnippets": false,
  "editor.suggest.showWords": false,
  "editor.suggest.showClasses": false,
  "editor.suggest.showFunctions": false,
  "editor.suggest.showVariables": false,
  "editor.suggest.showConstants": false,
  "editor.suggest.showEnums": false,
  "editor.suggest.showEnumMembers": false,
  "editor.suggest.showKeywords": false,
  "editor.suggest.showColors": false,
  "editor.suggest.showFiles": false,
  "editor.suggest.showReferences": false,
  "editor.suggest.showCustomcolors": false,
  "editor.suggest.showFolders": false,
  "editor.suggest.showTypeParameters": false,
  "editor.suggest.showUnits": false,
  "editor.suggest.showUsers": false,
  "editor.suggest.showValues": false
}
EOF

    echo "   üìù Configuration Cursor optimis√©e cr√©√©e"
    echo "   üí° Pour l'appliquer : copiez le contenu de $cursor_settings vers ~/.cursor/User/settings.json"
    
    echo -e "${GREEN}   ‚úÖ Configuration Cursor optimis√©e${NC}"
}

# Fonction de cr√©ation d'alias intelligents
create_intelligent_aliases() {
    echo ""
    echo -e "${CYAN}üöÄ Cr√©ation d'Alias Intelligents${NC}"
    echo "-------------------------------"

    # Ajouter les alias au .zshrc
    local zshrc="$HOME/.zshrc"
    
    # V√©rifier si les alias existent d√©j√†
    if ! grep -q "ath-optimize-intelligent" "$zshrc" 2>/dev/null; then
        cat >> "$zshrc" << 'EOF'

# Alias Athalia - Optimisation Intelligente
alias ath-optimize='./bin/ath-optimize-intelligent'
alias ath-clean-caches='sudo purge && sudo dscacheutil -flushcache'
alias ath-clean-python='find . -name "*.pyc" -delete && find . -name "__pycache__" -type d -exec rm -rf {} +'
alias ath-monitor-memory='./bin/ath-analyze-memory-consumers --quick'
alias ath-cursor-optimize='cp ~/.cursor/User/settings_optimized.json ~/.cursor/User/settings.json'
EOF
        echo "   üìù Alias ajout√©s au .zshrc"
    else
        echo "   ‚ÑπÔ∏è  Alias d√©j√† pr√©sents"
    fi

    echo -e "${GREEN}   ‚úÖ Alias intelligents cr√©√©s${NC}"
}

# Fonction de g√©n√©ration du rapport
generate_intelligent_report() {
    echo ""
    echo -e "${PURPLE}üìä Rapport d'Optimisation Intelligente${NC}"
    echo "====================================="

    local report_file="$HOME/optimization_intelligent_report_$(date +%Y%m%d_%H%M%S).md"

    {
        echo "# Rapport d'Optimisation Intelligente"
        echo "Date: $(date)"
        echo ""
        echo "## üéØ Optimisations Appliqu√©es"
        echo ""
        echo "### ‚úÖ Spotlight Optimis√©"
        echo "- Exclusions cibl√©es pour le projet Athalia"
        echo "- Dossiers de d√©veloppement exclus de l'indexation"
        echo "- Spotlight reste actif pour la recherche g√©n√©rale"
        echo ""
        echo "### ‚úÖ Caches Syst√®me Nettoy√©s"
        echo "- Cache DNS vid√©"
        echo "- Cache syst√®me purg√©"
        echo "- Fichiers Python temporaires supprim√©s"
        echo ""
        echo "### ‚úÖ Processus Optimis√©s"
        echo "- Priorit√© Cursor augment√©e"
        echo "- Processus Python optimis√©s"
        echo ""
        echo "### ‚úÖ Configuration Cursor"
        echo "- Fichier de configuration optimis√© cr√©√©"
        echo "- Exclusions de fichiers √©tendues"
        echo "- Fonctionnalit√©s non essentielles d√©sactiv√©es"
        echo ""
        echo "## üöÄ Commandes Disponibles"
        echo ""
        echo "```bash"
        echo "ath-optimize          # Relancer l'optimisation"
        echo "ath-clean-caches      # Nettoyer les caches"
        echo "ath-clean-python      # Nettoyer les fichiers Python"
        echo "ath-monitor-memory    # Surveiller la m√©moire"
        echo "ath-cursor-optimize   # Appliquer la config Cursor"
        echo "```"
        echo ""
        echo "## üìà Gains Attendus"
        echo "- R√©duction de l'utilisation Spotlight : ~100-150 MB"
        echo "- Nettoyage des caches : ~50-100 MB"
        echo "- Optimisation Cursor : ~200-300 MB"
        echo "- **Total estim√© : 350-550 MB**"
        echo ""
        echo "## ‚ö†Ô∏è  Services Pr√©serv√©s"
        echo "- ‚úÖ Cursor (fonctionnalit√© compl√®te)"
        echo "- ‚úÖ Extensions essentielles (Black, Mypy)"
        echo "- ‚úÖ Spotlight (recherche g√©n√©rale)"
        echo "- ‚úÖ Services syst√®me essentiels"
    } > "$report_file"

    echo -e "${GREEN}‚úÖ Rapport g√©n√©r√©: $report_file${NC}"
}

# Fonction principale
main() {
    case "${1:-}" in
        --help|-h)
            echo "Usage: ath-optimize-intelligent [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  --help, -h     Afficher cette aide"
            echo "  --quick        Optimisation rapide"
            echo ""
            echo "Description:"
            echo "  Optimisation intelligente SANS d√©sactiver les services essentiels"
            exit 0
            ;;
    esac

    optimize_spotlight_intelligent
    optimize_system_caches
    optimize_processes_intelligent
    optimize_cursor_intelligent
    create_intelligent_aliases
    generate_intelligent_report

    echo ""
    echo -e "${GREEN}üéâ Optimisation Intelligente Termin√©e !${NC}"
    echo ""
    echo "üìã Prochaines √©tapes :"
    echo "1. Rechargez votre shell : source ~/.zshrc"
    echo "2. Appliquez la config Cursor : ath-cursor-optimize"
    echo "3. Surveillez la m√©moire : ath-monitor-memory"
    echo ""
    echo "üí° Aucun service essentiel n'a √©t√© d√©sactiv√© !"
}

# Ex√©cution
main "$@" 