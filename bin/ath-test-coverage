#!/bin/bash
# Script pour tester la couverture de tests pour CI/CD
# Utilise: ./bin/ath-test-coverage

set -e

echo "ğŸ§ª TEST DE COUVERTURE ATHALIA"
echo "=============================="

# Activer l'environnement virtuel
source .venv/bin/activate

# Nettoyer les fichiers corrompus
echo "ğŸ§¹ Nettoyage des fichiers corrompus..."
find tests/ -name "*!*" -delete 2>/dev/null || true
find tests/ -name "*..*" -delete 2>/dev/null || true
find tests/ -name "._*" -delete 2>/dev/null || true

# VÃ©rifier le nombre de tests
echo "ğŸ“Š DÃ©couverte des tests..."
TEST_COUNT=$(python -m pytest --collect-only -q 2>/dev/null | wc -l)
echo "âœ… $TEST_COUNT tests dÃ©couverts"

# Nettoyer les fichiers de couverture corrompus
echo "ğŸ§¹ Nettoyage des fichiers de couverture..."
rm -f .coverage* 2>/dev/null || true

# Test de couverture avec timeout
echo "ğŸ” Test de couverture en cours..."
timeout 600 python -m pytest \
    
    --cov-report=term-missing \
    --cov-report=html:htmlcov \
    --tb=no \
    -q \
    --no-cov-on-fail \
    --disable-warnings \
    --maxfail=10

echo "âœ… Test de couverture terminÃ©" 