#!/bin/bash
# Script de fermeture propre pour Athalia
# Automatise le processus de nettoyage, commit, push et arrÃªt des processus

set -e

# Couleurs pour l'affichage
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Configuration
PROJECT_NAME="athalia-dev-setup"
BRANCH="develop"
REMOTE="origin"

echo -e "${BLUE}ðŸš€ DÃ©marrage de la fermeture propre d'Athalia${NC}"
echo -e "${BLUE}ðŸ“‚ Projet: $PROJECT_NAME${NC}"
echo -e "${BLUE}ðŸŒ¿ Branche: $BRANCH${NC}"
echo ""

# Fonction pour afficher les Ã©tapes
show_step() {
    echo -e "${CYAN}â–¶ï¸  $1${NC}"
}

# Fonction pour afficher le succÃ¨s
show_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

# Fonction pour afficher l'erreur
show_error() {
    echo -e "${RED}âŒ $1${NC}"
}

# Fonction pour afficher l'avertissement
show_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

# 1. VÃ©rifier l'Ã©tat du dÃ©pÃ´t Git
show_step "1. VÃ©rification de l'Ã©tat Git"
if ! git status --porcelain | grep -q .; then
    show_success "Aucun changement en attente"
else
    show_warning "Changements dÃ©tectÃ©s, prÃ©paration du commit..."
    
    # Ajouter tous les fichiers
    git add .
    
    # CrÃ©er un commit avec timestamp
    TIMESTAMP=$(date "+%Y-%m-%d %H:%M:%S")
    COMMIT_MSG="ðŸ§¹ Nettoyage automatique - $TIMESTAMP
    
    - Nettoyage des fichiers temporaires
    - Mise Ã  jour de la documentation
    - Correction des tests
    - Optimisation du code"
    
    if git commit -m "$COMMIT_MSG"; then
        show_success "Commit crÃ©Ã© avec succÃ¨s"
    else
        show_error "Erreur lors du commit"
        exit 1
    fi
fi

# 2. Pousser vers GitHub
show_step "2. Push vers GitHub"
if git push $REMOTE $BRANCH; then
    show_success "Code poussÃ© vers $REMOTE/$BRANCH"
else
    show_error "Erreur lors du push"
    exit 1
fi

# 3. ArrÃªter tous les processus Athalia
show_step "3. ArrÃªt des processus Athalia"
PROCESSES_STOPPED=0

# ArrÃªter les processus Python liÃ©s Ã  Athalia
for pid in $(pgrep -f "athalia\|ath-"); do
    if kill -TERM $pid 2>/dev/null; then
        show_success "Processus $pid arrÃªtÃ©"
        ((PROCESSES_STOPPED++))
    fi
done

# ArrÃªter les processus de test
for pid in $(pgrep -f "pytest.*athalia"); do
    if kill -TERM $pid 2>/dev/null; then
        show_success "Test $pid arrÃªtÃ©"
        ((PROCESSES_STOPPED++))
    fi
done

# ArrÃªter les serveurs de dÃ©veloppement
for pid in $(pgrep -f "python.*server\|uvicorn\|flask"); do
    if kill -TERM $pid 2>/dev/null; then
        show_success "Serveur $pid arrÃªtÃ©"
        ((PROCESSES_STOPPED++))
    fi
done

if [ $PROCESSES_STOPPED -eq 0 ]; then
    show_success "Aucun processus Ã  arrÃªter"
else
    show_success "$PROCESSES_STOPPED processus arrÃªtÃ©s"
fi

# 4. Nettoyer les fichiers temporaires macOS
show_step "4. Nettoyage des fichiers temporaires macOS"
if [ -f "./bin/ath-clean-macos-temp" ]; then
    if ./bin/ath-clean-macos-temp --execute; then
        show_success "Fichiers temporaires macOS nettoyÃ©s"
    else
        show_warning "Erreur lors du nettoyage macOS"
    fi
else
    show_warning "Script de nettoyage macOS non trouvÃ©"
fi

# 5. Nettoyer les caches Python
show_step "5. Nettoyage des caches Python"
find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
find . -name "*.pyc" -delete 2>/dev/null || true
find . -name "*.pyo" -delete 2>/dev/null || true
show_success "Caches Python nettoyÃ©s"

# 6. Nettoyer les fichiers temporaires
show_step "6. Nettoyage des fichiers temporaires"
find . -name "*.tmp" -delete 2>/dev/null || true
find . -name "*.temp" -delete 2>/dev/null || true
find . -name "*.log" -not -path "./logs/*" -delete 2>/dev/null || true
show_success "Fichiers temporaires nettoyÃ©s"

# 7. VÃ©rifier les rÃ¨gles de qualitÃ©
show_step "7. VÃ©rification des rÃ¨gles de qualitÃ©"

# VÃ©rifier la documentation
if [ -f "./docs/README.md" ] && [ -f "./docs/DEVELOPER/INDEX.md" ]; then
    show_success "Documentation principale prÃ©sente"
else
    show_warning "Documentation manquante"
fi

# VÃ©rifier les tests
if [ -d "./tests" ] && [ "$(find ./tests -name "*.py" | wc -l)" -gt 0 ]; then
    show_success "Tests prÃ©sents"
else
    show_warning "Tests manquants"
fi

# VÃ©rifier la structure du projet
if [ -f "./README.md" ] && [ -f "./requirements.txt" ]; then
    show_success "Structure du projet correcte"
else
    show_warning "Structure du projet incomplÃ¨te"
fi

# 8. VÃ©rifier l'Ã©tat final
show_step "8. VÃ©rification de l'Ã©tat final"

# VÃ©rifier qu'aucun processus ne tourne
RUNNING_PROCESSES=$(pgrep -f "athalia\|ath-" | wc -l)
if [ $RUNNING_PROCESSES -eq 0 ]; then
    show_success "Aucun processus Athalia en cours"
else
    show_warning "$RUNNING_PROCESSES processus encore actifs"
fi

# VÃ©rifier l'espace disque
DISK_USAGE=$(df . | tail -1 | awk '{print $5}' | sed 's/%//')
if [ $DISK_USAGE -lt 90 ]; then
    show_success "Espace disque suffisant ($DISK_USAGE%)"
else
    show_warning "Espace disque faible ($DISK_USAGE%)"
fi

# 9. GÃ©nÃ©rer un rapport de fermeture
show_step "9. GÃ©nÃ©ration du rapport de fermeture"
REPORT_FILE="./logs/shutdown_report_$(date +%Y%m%d_%H%M%S).txt"

mkdir -p ./logs

cat > "$REPORT_FILE" << EOF
=== RAPPORT DE FERMETURE ATHALIA ===
Date: $(date)
Projet: $PROJECT_NAME
Branche: $BRANCH

=== Ã‰TAT GIT ===
$(git status --porcelain | wc -l) fichiers modifiÃ©s
Dernier commit: $(git log -1 --oneline)

=== PROCESSUS ===
$PROCESSES_STOPPED processus arrÃªtÃ©s
$RUNNING_PROCESSES processus encore actifs

=== ESPACE DISQUE ===
Utilisation: $DISK_USAGE%

=== FICHIERS TEMPORAIRES ===
$(find . -name ".*" -type f | wc -l) fichiers cachÃ©s
$(find . -name "*.tmp" -o -name "*.temp" | wc -l) fichiers temporaires

=== DOCUMENTATION ===
README.md: $(test -f "./README.md" && echo "âœ…" || echo "âŒ")
Documentation dÃ©veloppeur: $(test -f "./docs/DEVELOPER/INDEX.md" && echo "âœ…" || echo "âŒ")

=== TESTS ===
Fichiers de test: $(find ./tests -name "*.py" | wc -l)

=== RÃ‰SUMÃ‰ ===
Fermeture: $(test $RUNNING_PROCESSES -eq 0 && echo "âœ… Propre" || echo "âš ï¸  IncomplÃ¨te")
EOF

show_success "Rapport gÃ©nÃ©rÃ©: $REPORT_FILE"

# 10. Affichage du rÃ©sumÃ© final
echo ""
echo -e "${PURPLE}ðŸŽ‰ FERMETURE TERMINÃ‰E${NC}"
echo -e "${PURPLE}===================${NC}"
echo -e "${GREEN}âœ… Code poussÃ© vers GitHub${NC}"
echo -e "${GREEN}âœ… Processus arrÃªtÃ©s${NC}"
echo -e "${GREEN}âœ… Fichiers temporaires nettoyÃ©s${NC}"
echo -e "${GREEN}âœ… RÃ¨gles de qualitÃ© vÃ©rifiÃ©es${NC}"
echo -e "${GREEN}âœ… Rapport gÃ©nÃ©rÃ©${NC}"
echo ""
echo -e "${CYAN}ðŸ“Š Statistiques:${NC}"
echo -e "   - Processus arrÃªtÃ©s: $PROCESSES_STOPPED"
echo -e "   - Espace disque: $DISK_USAGE%"
echo -e "   - Rapport: $REPORT_FILE"
echo ""
echo -e "${YELLOW}ðŸ’¡ Conseil: VÃ©rifiez le rapport pour plus de dÃ©tails${NC}"
echo "" 