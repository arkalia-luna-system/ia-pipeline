#!/bin/bash
# -*- coding: utf-8 -*-
"""
Script de nettoyage des fichiers Apple Double dans le dossier tests.
Supprime automatiquement tous les fichiers ._* cr√©√©s par macOS.
"""

set -euo pipefail

# Couleurs pour l'affichage
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
TESTS_DIR="tests"
BACKUP_DIR="backups/appledouble_cleanup"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")

echo -e "${BLUE}üßπ Nettoyage des fichiers Apple Double - Athalia${NC}"
echo "=================================================="

# V√©rifier que le dossier tests existe
if [[ ! -d "$TESTS_DIR" ]]; then
    echo -e "${RED}‚ùå Erreur: Le dossier $TESTS_DIR n'existe pas${NC}"
    exit 1
fi

# Cr√©er le dossier de backup
mkdir -p "$BACKUP_DIR"

# Compter les fichiers Apple Double avant nettoyage
echo -e "${YELLOW}üìä Analyse des fichiers Apple Double...${NC}"
APPLE_DOUBLE_COUNT=$(find "$TESTS_DIR" -name "._*" -type f | wc -l | tr -d ' ')

if [[ $APPLE_DOUBLE_COUNT -eq 0 ]]; then
    echo -e "${GREEN}‚úÖ Aucun fichier Apple Double trouv√© dans $TESTS_DIR${NC}"
    exit 0
fi

echo -e "${YELLOW}üìÅ Trouv√© $APPLE_DOUBLE_COUNT fichiers Apple Double${NC}"

# Lister les fichiers trouv√©s
echo -e "${BLUE}üìã Fichiers Apple Double d√©tect√©s:${NC}"
find "$TESTS_DIR" -name "._*" -type f | head -10

if [[ $APPLE_DOUBLE_COUNT -gt 10 ]]; then
    echo -e "${YELLOW}   ... et $((APPLE_DOUBLE_COUNT - 10)) autres fichiers${NC}"
fi

# Demander confirmation
echo ""
echo -e "${YELLOW}‚ö†Ô∏è  Voulez-vous supprimer ces $APPLE_DOUBLE_COUNT fichiers ? (y/N)${NC}"
read -r response

if [[ ! "$response" =~ ^[Yy]$ ]]; then
    echo -e "${BLUE}üõë Nettoyage annul√©${NC}"
    exit 0
fi

# Cr√©er un backup avant suppression
echo -e "${BLUE}üíæ Cr√©ation du backup...${NC}"
BACKUP_FILE="$BACKUP_DIR/appledouble_backup_$TIMESTAMP.txt"
find "$TESTS_DIR" -name "._*" -type f > "$BACKUP_FILE"
echo -e "${GREEN}‚úÖ Backup cr√©√©: $BACKUP_FILE${NC}"

# Supprimer les fichiers Apple Double
echo -e "${YELLOW}üóëÔ∏è  Suppression des fichiers Apple Double...${NC}"
find "$TESTS_DIR" -name "._*" -type f -delete

# V√©rifier le r√©sultat
REMAINING_COUNT=$(find "$TESTS_DIR" -name "._*" -type f | wc -l | tr -d ' ')
DELETED_COUNT=$((APPLE_DOUBLE_COUNT - REMAINING_COUNT))

if [[ $REMAINING_COUNT -eq 0 ]]; then
    echo -e "${GREEN}‚úÖ Nettoyage r√©ussi ! $DELETED_COUNT fichiers supprim√©s${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è  Nettoyage partiel: $DELETED_COUNT fichiers supprim√©s, $REMAINING_COUNT restants${NC}"
fi

# Afficher les statistiques finales
echo ""
echo -e "${BLUE}üìä Statistiques finales:${NC}"
echo "   ‚Ä¢ Fichiers Apple Double supprim√©s: $DELETED_COUNT"
echo "   ‚Ä¢ Fichiers restants: $REMAINING_COUNT"
echo "   ‚Ä¢ Backup cr√©√©: $BACKUP_FILE"

# V√©rifier l'espace disque lib√©r√© (approximatif)
echo ""
echo -e "${GREEN}üéâ Nettoyage termin√© avec succ√®s !${NC}"
echo "==================================================" 