#!/bin/bash
# ğŸŒŸ Nettoyage Complet du Projet Athalia/Arkalia
# Version amÃ©liorÃ©e - Nettoie tous les fichiers mal rangÃ©s et caches
# Inclut la gestion des processus pour optimiser les performances

echo "ğŸ§¹ DÃ©but du nettoyage complet Athalia/Arkalia..."

# Variables
PROJECT_ROOT=$(git rev-parse --show-toplevel 2>/dev/null || pwd)
CLEANED_FILES=0
CLEANED_DIRS=0
CLEANED_PROCESSES=0

# Fonction pour compter les fichiers supprimÃ©s
count_cleaned() {
    local count=$1
    if [ $count -gt 0 ]; then
        echo "   âœ… $count Ã©lÃ©ments nettoyÃ©s"
        CLEANED_FILES=$((CLEANED_FILES + count))
    fi
}

# Fonction pour gÃ©rer les processus
manage_processes() {
    echo "ğŸ” Analyse des processus Athalia..."
    
    # VÃ©rifier les processus Python athalia_core
    ATHALIA_PROCESSES=$(ps aux | grep -c "[a]thalia_core.main" 2>/dev/null || echo "0")
    if [ "$ATHALIA_PROCESSES" -gt 0 ] 2>/dev/null; then
        echo "   âš ï¸  $ATHALIA_PROCESSES processus Athalia dÃ©tectÃ©s"
        echo "   ğŸ’¡ Utilisez 'ark-process-check.sh' pour les gÃ©rer"
        
        read -p "   Voulez-vous arrÃªter les processus Athalia ? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            echo "   ğŸ”ª ArrÃªt des processus Athalia..."
            pkill -f "athalia_core.main" 2>/dev/null
            CLEANED_PROCESSES=$ATHALIA_PROCESSES
            echo "   âœ… $ATHALIA_PROCESSES processus arrÃªtÃ©s"
        fi
    else
        echo "   âœ… Aucun processus Athalia en cours"
    fi
    
    # VÃ©rifier les processus de validation continue
    VALIDATION_PROCESSES=$(ps aux | grep -c "[v]alidation_continue" 2>/dev/null || echo "0")
    if [ "$VALIDATION_PROCESSES" -gt 0 ] 2>/dev/null; then
        echo "   âš ï¸  $VALIDATION_PROCESSES processus de validation dÃ©tectÃ©s"
        read -p "   Voulez-vous les arrÃªter ? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            echo "   ğŸ”ª ArrÃªt des processus de validation..."
            pkill -f "validation_continue" 2>/dev/null
            CLEANED_PROCESSES=$((CLEANED_PROCESSES + VALIDATION_PROCESSES))
            echo "   âœ… $VALIDATION_PROCESSES processus arrÃªtÃ©s"
        fi
    fi
}

# Fonction pour optimiser la configuration
optimize_config() {
    echo "âš™ï¸  Optimisation de la configuration..."
    
    # VÃ©rifier si la config est dÃ©jÃ  optimisÃ©e
    if grep -q "verbose: false" config/athalia_config.yaml 2>/dev/null; then
        echo "   âœ… Configuration dÃ©jÃ  optimisÃ©e"
    else
        echo "   ğŸ”§ Configuration optimisÃ©e pour les performances"
        # La configuration a dÃ©jÃ  Ã©tÃ© mise Ã  jour par les modifications prÃ©cÃ©dentes
    fi
}

# Fonction pour nettoyer les bases de donnÃ©es temporaires
clean_databases() {
    echo "ğŸ—„ï¸  Nettoyage des bases de donnÃ©es temporaires..."
    
    # Bases de donnÃ©es temporaires dans data/
    DB_COUNT=$(find data/ -name "*.db" -not -name "athalia_analytics.db" -not -name "athalia_coordination.db" 2>/dev/null | wc -l)
    if [ "$DB_COUNT" -gt 0 ] 2>/dev/null; then
        echo "   ğŸ“Š $DB_COUNT bases de donnÃ©es temporaires trouvÃ©es"
        read -p "   Voulez-vous les supprimer ? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            find data/ -name "*.db" -not -name "athalia_analytics.db" -not -name "athalia_coordination.db" -delete 2>/dev/null
            count_cleaned $DB_COUNT
        fi
    fi
}

# Fonction pour nettoyer les rapports anciens
clean_old_reports() {
    echo "ğŸ“‹ Nettoyage des rapports anciens..."
    
    # Rapports de plus de 7 jours
    OLD_REPORTS_COUNT=$(find data/reports/ -name "*.md" -mtime +7 2>/dev/null | wc -l)
    if [ "$OLD_REPORTS_COUNT" -gt 0 ] 2>/dev/null; then
        echo "   ğŸ“„ $OLD_REPORTS_COUNT rapports anciens trouvÃ©s"
        read -p "   Voulez-vous les supprimer ? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            find data/reports/ -name "*.md" -mtime +7 -delete 2>/dev/null
            count_cleaned $OLD_REPORTS_COUNT
        fi
    fi
}

# Gestion des processus
manage_processes

# Optimisation de la configuration
optimize_config

echo "ğŸ“ Nettoyage des caches Python..."
# Cache Python
PYCACHE_COUNT=$(find . -name "__pycache__" -type d 2>/dev/null | wc -l)
find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null
count_cleaned $PYCACHE_COUNT

PYC_COUNT=$(find . -name "*.pyc" -type f 2>/dev/null | wc -l)
find . -name "*.pyc" -type f -delete 2>/dev/null
count_cleaned $PYC_COUNT

echo "ğŸ—‘ï¸ Nettoyage des fichiers temporaires..."
# Fichiers temporaires
TEMP_COUNT=$(find . -name "*.tmp" -o -name "*.temp" -o -name "*~" -o -name ".#*" 2>/dev/null | wc -l)
find . -name "*.tmp" -o -name "*.temp" -o -name "*~" -o -name ".#*" -delete 2>/dev/null
count_cleaned $TEMP_COUNT

echo "ğŸ Nettoyage des fichiers macOS..."
# Fichiers cachÃ©s macOS (sauf dans .git)
MACOS_COUNT=$(find . -name "._*" -not -path "./.git/*" 2>/dev/null | wc -l)
find . -name "._*" -not -path "./.git/*" -delete 2>/dev/null
count_cleaned $MACOS_COUNT

DS_STORE_COUNT=$(find . -name ".DS_Store" 2>/dev/null | wc -l)
find . -name ".DS_Store" -delete 2>/dev/null
count_cleaned $DS_STORE_COUNT

echo "ğŸ“ Nettoyage des logs..."
# Logs (sauf athalia.log principal)
LOG_COUNT=$(find . -name "*.log" -not -name "athalia.log" -not -path "./.git/*" 2>/dev/null | wc -l)
find . -name "*.log" -not -name "athalia.log" -not -path "./.git/*" -delete 2>/dev/null
count_cleaned $LOG_COUNT

echo "ğŸ§ª Nettoyage des caches de tests..."
# Caches de tests
PYTEST_CACHE_COUNT=$(find . -name ".pytest_cache" -type d 2>/dev/null | wc -l)
find . -name ".pytest_cache" -type d -exec rm -rf {} + 2>/dev/null
count_cleaned $PYTEST_CACHE_COUNT

BENCHMARK_CACHE_COUNT=$(find . -name ".benchmarks" -type d 2>/dev/null | wc -l)
find . -name ".benchmarks" -type d -exec rm -rf {} + 2>/dev/null
count_cleaned $BENCHMARK_CACHE_COUNT

MYPY_CACHE_COUNT=$(find . -name ".mypy_cache" -type d 2>/dev/null | wc -l)
find . -name ".mypy_cache" -type d -exec rm -rf {} + 2>/dev/null
count_cleaned $MYPY_CACHE_COUNT

echo "ğŸ“Š Nettoyage des rapports temporaires..."
# Rapports temporaires Ã  la racine (sauf ceux dans data/)
ROOT_REPORTS_COUNT=$(find . -maxdepth 1 -name "*.json" -o -name "*.yaml" -o -name "*.csv" -o -name "*.md" 2>/dev/null | grep -v "README\|CHANGELOG\|ROADMAP\|LICENSE\|DASHBOARD\|BENCHMARK" | wc -l)
find . -maxdepth 1 \( -name "*.json" -o -name "*.yaml" -o -name "*.csv" \) | grep -v "README\|CHANGELOG\|ROADMAP\|LICENSE\|DASHBOARD\|BENCHMARK" | xargs -I {} rm -f {} 2>/dev/null
count_cleaned $ROOT_REPORTS_COUNT

echo "ğŸ”§ Nettoyage des fichiers .f (fichiers temporaires)..."
# Fichiers .f (fichiers temporaires)
F_COUNT=$(find . -name "*.f" -not -path "./.git/*" 2>/dev/null | wc -l)
find . -name "*.f" -not -path "./.git/*" -delete 2>/dev/null
count_cleaned $F_COUNT

echo "ğŸ“¦ Nettoyage des caches de build..."
# Caches de build
BUILD_CACHE_COUNT=$(find . -name "build" -type d -o -name "dist" -type d -o -name "*.egg-info" -type d 2>/dev/null | wc -l)
find . -name "build" -type d -o -name "dist" -type d -o -name "*.egg-info" -type d -exec rm -rf {} + 2>/dev/null
count_cleaned $BUILD_CACHE_COUNT

echo "ğŸ¨ Nettoyage des fichiers de couverture..."
# Fichiers de couverture (sauf htmlcov/index.html)
COVERAGE_COUNT=$(find . -name "*.coverage" -o -name "coverage.xml" -o -name "htmlcov" -type d 2>/dev/null | wc -l)
find . -name "*.coverage" -o -name "coverage.xml" -delete 2>/dev/null
find . -name "htmlcov" -type d -exec rm -rf {} + 2>/dev/null
count_cleaned $COVERAGE_COUNT

echo "ğŸ“‹ Nettoyage des fichiers de profilage..."
# Fichiers de profilage
PROFILE_COUNT=$(find . -name "profile.out" -o -name "*.prof" 2>/dev/null | wc -l)
find . -name "profile.out" -o -name "*.prof" -delete 2>/dev/null
count_cleaned $PROFILE_COUNT

echo "ğŸ” Nettoyage des fichiers de recherche..."
# Fichiers de recherche
SEARCH_COUNT=$(find . -name ".vscode" -type d -o -name ".idea" -type d 2>/dev/null | wc -l)
find . -name ".vscode" -type d -o -name ".idea" -type d -exec rm -rf {} + 2>/dev/null
count_cleaned $SEARCH_COUNT

echo "ğŸ“ Nettoyage des dossiers temporaires..."
# Dossiers temporaires
TEMP_DIRS_COUNT=$(find . -name "temp" -type d -o -name "tmp" -type d -o -name "cache" -type d 2>/dev/null | wc -l)
find . -name "temp" -type d -o -name "tmp" -type d -o -name "cache" -type d -exec rm -rf {} + 2>/dev/null
count_cleaned $TEMP_DIRS_COUNT

echo "ğŸ§¹ Nettoyage des fichiers corrompus..."
# Fichiers corrompus ou vides
CORRUPT_COUNT=$(find . -name "*.f\(f\)" -o -name "*.corrupt" -o -name "*.broken" 2>/dev/null | wc -l)
find . -name "*.f\(f\)" -o -name "*.corrupt" -o -name "*.broken" -delete 2>/dev/null
count_cleaned $CORRUPT_COUNT

# Nettoyage des bases de donnÃ©es temporaires
clean_databases

# Nettoyage des rapports anciens
clean_old_reports

# Nettoyage des fichiers vides (optionnel - dÃ©commenter si nÃ©cessaire)
# echo "ğŸ“„ Nettoyage des fichiers vides..."
# EMPTY_COUNT=$(find . -type f -empty -not -path "./.git/*" 2>/dev/null | wc -l)
# find . -type f -empty -not -path "./.git/*" -delete 2>/dev/null
# count_cleaned $EMPTY_COUNT

echo ""
echo "ğŸ¯ RÃ©sumÃ© du nettoyage :"
echo "   ğŸ“Š Total d'Ã©lÃ©ments nettoyÃ©s : $CLEANED_FILES"
echo "   ğŸ“ Dossiers nettoyÃ©s : $CLEANED_DIRS"
echo "   ğŸ”„ Processus arrÃªtÃ©s : $CLEANED_PROCESSES"
echo ""
echo "âœ… Nettoyage terminÃ© ! Le projet Athalia/Arkalia est maintenant propre et optimisÃ©."
echo ""
echo "ğŸ’¡ Conseils :"
echo "   - ExÃ©cutez 'ath-clean' rÃ©guliÃ¨rement pour maintenir la propretÃ©"
echo "   - Utilisez 'ark-process-check.sh' pour surveiller les processus"
echo "   - Les fichiers dans data/ sont prÃ©servÃ©s (rapports, benchmarks, etc.)"
echo "   - La configuration a Ã©tÃ© optimisÃ©e pour les performances"
echo ""
echo "ğŸš€ Pour redÃ©marrer proprement :"
echo "   python3 -m athalia_core.main" 