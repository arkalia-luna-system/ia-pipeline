name: CI Professional - Level 1

on:
  push:
    branches: [ci-cd-professional, develop, reorganize-tests]
  pull_request:
    branches: [ci-cd-professional, develop, reorganize-tests]

jobs:
  test-basic:
    runs-on: ubuntu-latest
    env:
      CI: true
      PYTHONPATH: ${{ github.workspace }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r config/requirements-minimal.txt
          pip install requests>=2.28.0
          pip install pytest-timeout pytest-xdist black ruff

      - name: Run basic tests
        run: |
          echo "ðŸ§ª Running basic tests..."
          python -m pytest tests/ --cov=athalia_core --cov-report=term-missing --cov-fail-under=5 --tb=short -x --maxfail=10 --timeout=60

      - name: Basic linting
        run: |
          echo "ðŸ” Running basic linting..."
          flake8 --config=config/.flake8 .
          black . --check --diff
          ruff check .

      - name: Check essential imports
        run: |
          echo "ðŸ“¦ Checking essential imports..."
          python -c "
          import sys
          sys.path.insert(0, '.')
          errors = []
          modules = ['athalia_core.audit', 'athalia_core.cleanup', 'athalia_core.analytics']
          for module in modules:
              try:
                  __import__(module)
                  print(f'âœ… {module} imported successfully')
              except ImportError as e:
                  errors.append(f'{module}: {e}')
                  print(f'âš ï¸ {module} import failed: {e}')
          if len(errors) > 1:
              print('Too many import errors')
              exit(1)
          print('Essential imports check completed')
          "

      - name: Generate Level 1 Report
        if: always()
        run: |
          cat > ci_pro_level1_report.md << EOF
          # ðŸ“Š CI Professional - Level 1 Report

          ## ðŸŽ¯ Niveau: 1/5 - Tests de Base

          ### ðŸ“… Date: $(date)
          ### ðŸŒ¿ Branche: ${{ github.ref_name }}
          ### ðŸ‘¤ Acteur: ${{ github.actor }}

          ### âœ… Tests ExÃ©cutÃ©s:
          - Tests de base (non-slow)
          - Linting (flake8, black, ruff)
          - VÃ©rification des imports essentiels

          ### ðŸ“ˆ MÃ©triques:
          - **Status:** ${{ job.status }}
          - **Temps d'exÃ©cution:** ~5 minutes
          - **ComplexitÃ©:** Basique

          ### ðŸš€ Prochain Niveau:
          - **Niveau 2:** Tests de sÃ©curitÃ©
          - **Niveau 3:** Tests de performance
          - **Niveau 4:** Multi-environnement
          - **Niveau 5:** DÃ©ploiement continu

          ### ðŸ“‹ Actions RecommandÃ©es:
          - Si tous les tests passent â†’ Passer au Niveau 2
          - Si Ã©chec â†’ Corriger et relancer

          EOF

      - name: Upload Level 1 Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ci-pro-level1-report
          path: ci_pro_level1_report.md

      - name: Update Progress Tracker
        if: always()
        run: |
          cat > ci_progress.json << EOF
          {
            "level": 1,
            "status": "${{ job.status }}",
            "tests_passed": "basic",
            "security_score": 0,
            "performance_score": 0,
            "coverage": 0,
            "last_update": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "next_level": "security",
            "branch": "${{ github.ref_name }}",
            "actor": "${{ github.actor }}"
          }
          EOF

      - name: Upload Progress Tracker
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ci-progress-tracker
          path: ci_progress.json
